#! /bin/bash -e

function usage() {
  cat <<@EOF
Usage: git cms-cherry-pick <commit1>[..<commit2>] [--remote <remote>] [<cherry-pick optional arguments>]

Description:
  Cherry pick commit(s), ensuring modified subpackages are added before the commits are applied.
@EOF
  exit $1
}

# mandatory commit(s) to cherry-pick
COMMITS=${1}
[ "$COMMITS" ] || usage 1

# optional remote
REMOTE=""

# store options before their deletion in the loop below
OPTIONS=("$@")

while [[ $# -gt 0 ]]; do
    shift; # start after the commit argument
    key=${1} 
    case $key in
	-h|--help)
	    usage 1
	    exit 1
	    ;;
	-r|--remote)
	    REMOTE=${2}
	    shift; shift;
	    ;;
    esac
done

# go to release
[ "$CMSSW_BASE" ] && cd $CMSSW_BASE/src

# add repository where commits to be cherry-picked can be found
if [ -n "${REMOTE}" ]; then
    git cms-remote add ${REMOTE}
    git fetch ${REMOTE}
fi

# download modified subpackages
git diff ${COMMITS} --name-only --no-renames | cut -d/ -f-2 | sort -u | xargs -r git cms-addpkg

# cherry-pick with user arguments

if [ -n ${REMOTE} ]; then
    git cherry-pick ${COMMITS} ${OPTIONS[@]:3}
else
    git cherry-pick ${COMMITS} ${OPTIONS[@]:1}
fi
